package controller;

import java.util.concurrent.Semaphore;

public class ThreadBilhete extends Thread {

	private int idBilhete;
	private static int processoLogin;
	private static int processoValidar;
	private Semaphore semaforo;

	public ThreadBilhete(int idBilhete, Semaphore semaforo) {
		this.idBilhete = idBilhete;
		this.semaforo = semaforo;
	}

	// Até aqui, eu dei nome aos bois.

	// Começa o processo construtor

	public void run() {
		tentandoLogar();
		try {
			// --------P (Acquire)-------------
			semaforo.acquire();
			tentandoComprar();
		} catch (InterruptedException e) {
			e.printStackTrace();
		} finally {
			// --------V (Release)-------------
			semaforo.release();
			tentandoValidar();

		}
	}

	private void tentandoLogar() {
		int tempoUsado = 0;
		int tempoLimite = 1000;
		int tempo = 50;

		while (tempoUsado < tempoLimite) {
			tempoUsado = (int) ((Math.random() * 50) + 1951);

			if (tempoUsado > 1000) {
				try {
					sleep(tempo);
				} catch (InterruptedException e) {
					e.printStackTrace();
				}
				System.out.println("Timeout.");
			} else {
				processoLogin++;
				System.out.println("Usuário " + processoLogin + " logou.");
			}

		}

	}

	private void tentandoComprar() {

		int tempoComprando = 0;
		int tempoMaximo = 2000;
		int tempo = 50;

		while (tempoComprando < tempoMaximo) {
			tempoComprando = (int) ((Math.random() * 1000) + 2000);

			if (tempoComprando > 2500) {
				try {
					sleep(tempo);
				} catch (InterruptedException e) {
					e.printStackTrace();
				}
				System.out.println("Encerrado login, compra não efetuada");
			} else {
				System.out.println("Enviado para validação");
			}

		}
	}

	private void tentandoValidar() {

		int compraBilhete = 0;
		int totalBilhete = 100;

		while (compraBilhete <= totalBilhete) {
			compraBilhete = (int) ((Math.random() * 1) + 4);

			if (totalBilhete <= 0) {
				System.out.println("Bilhete esgotado.");
				break;
			} else {
				processoValidar++;
				System.out.println(" Usuário comprou: " + compraBilhete + " bilhete(s) código: " + idBilhete);
				totalBilhete = totalBilhete - compraBilhete;

			}

		}

	}
}
